<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Caja - Multimotos 2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Estilos institucionales -->
  <style>
    :root{
      --azul:#102962;          /* Azul oscuro */
      --gris:#f4f4f4;          /* Gris claro */
      --blanco:#ffffff;        /* Blanco */
    }

    body{ background:var(--gris); }

    .page-title{
      color:var(--azul);
      font-weight:800;
    }

    .card{
      border:0;
      border-radius:18px;
      box-shadow:0 8px 26px rgba(16,41,98,.08);
      background:var(--blanco);
    }
    .card-title{
      color:var(--azul);
      font-weight:800;
    }

    .label-strong{ font-weight:700; color:var(--azul); }

    .stat{
      background:var(--blanco);
      border-radius:14px;
      padding:12px 16px;
      box-shadow:0 4px 16px rgba(16,41,98,.06);
      height:100%;
    }
    .stat .value{
      font-size:1.1rem;
      font-weight:800;
      color:var(--azul);
    }

    .btn-primary{ background:var(--azul); border:0; }
    .btn-primary:hover{ background:#0b1d49; }

    .table thead th{
      position:sticky;
      top:0;
      background:var(--azul);
      color:#fff;
      z-index:1;
    }

    /* filas clicables en historial */
    .clickable-row { cursor:pointer; }
    .clickable-row:hover { background:#f6f8ff; }

    @media (max-width: 576px){
      .stat .value{ font-size:1rem; }
      .card{ border-radius:14px; }
    }

    /* Ocultar los spinners (flechas +/-) en inputs number */
    /* Chrome, Safari, Edge, Opera */
    input[type=number]::-webkit-outer-spin-button,
    input[type=number]::-webkit-inner-spin-button {
      -webkit-appearance: none;
      margin: 0;
    }
    /* Firefox */
    input[type=number] {
      -moz-appearance: textfield;
    }
  </style>
</head>
<body class="py-4">
  <div class="container-xxl">
    <h2 class="mb-4 page-title">Apertura y Cierre de Caja</h2>

    <!-- APERTURA -->
    <section class="card mb-4">
      <div class="card-body">
        <div class="d-flex flex-wrap align-items-end justify-content-between gap-3 mb-3">
          <h5 class="card-title mb-0">Apertura de Caja</h5>
          <!-- Estado de caja (se actualiza por JS): Abierta / Cerrada / Sin apertura -->
          <span id="estado_caja" class="badge text-bg-secondary px-3 py-2">—</span>
        </div>
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label for="fecha_apertura" class="form-label">Fecha</label>
            <input type="date" id="fecha_apertura" class="form-control" />
          </div>

          <div class="col-12 col-md-3">
            <label for="monto_apertura" class="form-label">Monto inicial</label>
            <input type="number" step="0.01" id="monto_apertura" class="form-control" placeholder="0.00" />
          </div>

          <div class="col-12 col-md-3 d-grid">
            <label class="form-label d-none d-md-block">&nbsp;</label>
            <button id="btn_aperturar" class="btn btn-primary fw-bold">Aperturar Caja</button>
          </div>

          <div class="col-12 col-md-3">
            <div class="alert alert-info mb-0">
              <div class="small">Recuerda:</div>
              <strong>Solo una apertura por fecha</strong>.
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- RESUMEN -->
    <section class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Resumen del Día</h5>

        <div class="row g-3">
          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat h-100">
              <div class="label-strong">Monto inicial</div>
              <div class="value" id="r_monto_inicial">$0.00</div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat h-100">
              <div class="label-strong">Ingresos en efectivo</div>
              <div class="value" id="r_ingresos_efectivo">$0.00</div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat h-100">
              <div class="label-strong">Ingresos en banco</div>
              <div class="value" id="r_ingresos_banco">$0.00</div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat h-100">
              <div class="label-strong">Cuentas por cobrar</div>
              <div class="value" id="r_cuentas_cobrar">$0.00</div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat h-100">
              <div class="label-strong">Gastos / Salidas</div>
              <div class="value" id="r_gastos">$0.00</div>
            </div>
          </div>

          <div class="col-12 col-sm-6 col-lg-4">
            <div class="stat h-100">
              <div class="label-strong">Total calculado</div>
              <div class="value" id="r_total">$0.00</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- CIERRE -->
    <section class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Cierre de Caja</h5>
        <div class="row g-3">
          <div class="col-12 col-md-3">
            <label for="monto_fisico" class="form-label">Monto físico (contado)</label>
            <input type="number" step="0.01" id="monto_fisico" class="form-control" placeholder="0.00" />
          </div>

          <div class="col-12 col-md-6">
            <label for="observaciones" class="form-label">Observaciones (obligatorio si hay diferencia)</label>
            <textarea id="observaciones" rows="2" class="form-control" placeholder="Ej.: faltante por error de cambio"></textarea>
          </div>

          <div class="col-12 col-md-3 d-grid">
            <label class="form-label d-none d-md-block">&nbsp;</label>
            <button id="btn_cerrar" class="btn btn-success fw-bold">Cerrar Caja</button>
          </div>
        </div>
      </div>
    </section>

    <!-- HISTORIAL -->
    <section class="card mb-4">
      <div class="card-body">
        <h5 class="card-title mb-3">Historial de Cajas</h5>
        <div class="table-responsive" style="max-height:360px;">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th>Fecha</th>
                <th class="text-end">Monto inicial</th>
                <th class="text-end">Monto final</th>
                <th class="text-end">Total ingreso</th>
                <th class="text-end">Total gasto</th>
                <th>Observaciones</th>
              </tr>
            </thead>
            <tbody id="tabla_historial"></tbody>
          </table>
        </div>
      </div>
    </section>
  </div>

  <!-- MODAL: Movimientos de la caja seleccionada -->
  <div class="modal fade" id="modalMovimientos" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header" style="background:#102962;">
          <h5 class="modal-title text-white">Movimientos del día <span id="modal_fecha"></span></h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body">
          <div class="table-responsive" style="max-height:60vh;">
            <table class="table table-sm align-middle">
              <thead>
                <tr>
                  <th>Hora</th>
                  <th>Tipo de transacción</th>
                  <th>Tipo de pago</th>
                  <th>Detalle / Descripción</th>
                  <th class="text-end">Valor</th>
                </tr>
              </thead>
              <tbody id="tabla_movimientos_modal"></tbody>
            </table>
          </div>
        </div>
        <div class="modal-footer">
          <button class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="js/caja.js"></script>

  <!-- Script: Estado de caja (Abierta/Cerrada/Sin apertura) y bloqueo doble apertura -->
  <script>
    (function(){
      const $ = (sel) => document.querySelector(sel);
      const estadoBadge = $('#estado_caja');
      const inFecha = $('#fecha_apertura');
      const btnAperturar = $('#btn_aperturar');
      const btnCerrar = $('#btn_cerrar');

      function hoyISO(){
        const d = new Date();
        const tzOff = d.getTimezoneOffset() * 60000;
        return new Date(Date.now() - tzOff).toISOString().slice(0,10);
      }

      async function actualizarEstadoCaja(){
        try{
          const fecha = (inFecha && inFecha.value) ? inFecha.value : hoyISO();
          const res = await fetch(`/api/caja/estado?fecha=${encodeURIComponent(fecha)}`, { headers: { 'Accept':'application/json' }});
          if(!res.ok){ throw new Error(await res.text()); }
          const data = await res.json();

          let txt = 'Sin apertura';
          if (data.estado === 'abierta') txt = 'Abierta';
          else if (data.estado === 'cerrada') txt = 'Cerrada';

          if (estadoBadge) estadoBadge.textContent = txt;

          // No permitir abrir otra caja si ya existe una para esa fecha
          if (btnAperturar) btnAperturar.disabled = (data.estado !== 'sin_apertura');

        } catch(e){
          if (estadoBadge) estadoBadge.textContent = '—';
        }
      }

      document.addEventListener('DOMContentLoaded', actualizarEstadoCaja);
      if (inFecha) inFecha.addEventListener('change', actualizarEstadoCaja);
      if (btnAperturar) btnAperturar.addEventListener('click', () => setTimeout(actualizarEstadoCaja, 600));
      if (btnCerrar) btnCerrar.addEventListener('click', () => setTimeout(actualizarEstadoCaja, 600));
    })();
  </script>

  <!-- Script: Completar “Total ingreso” y “Total gasto” en el Historial sin cambiar diseño -->
  <script>
    (function(){
      const $$ = (sel) => Array.from(document.querySelectorAll(sel));
      const fmt = (n) => Number(n||0).toLocaleString('es-EC', { style:'currency', currency:'USD', minimumFractionDigits:2 });

      // Reglas de clasificación (coinciden con backend)
      const GASTO_VARIANTES = ['gasto','salida','egreso'];

      async function calcularTotalesPorFecha(fecha){
        try{
          const res = await fetch(`/api/caja/movimientos?fecha=${encodeURIComponent(fecha)}`, { headers: { 'Accept':'application/json' }});
          if(!res.ok) throw new Error(await res.text());
          const rows = await res.json();

          let ingreso = 0;
          let gasto   = 0;

          for (const r of rows){
            const tx = (r.tipo_transaccion||'').toString().toLowerCase().trim();
            const tp = (r.tipo_pago||'').toString().toLowerCase().trim();
            const monto = Number(r.monto||0);

            const esGasto = GASTO_VARIANTES.includes(tx);
            const esPendiente = tp === 'pendiente';

            if (esGasto){
              gasto += monto;
            } else {
              // Solo consideramos ingresos pagados (efectivo/transferencia/tarjeta, etc.)
              if (!esPendiente){
                ingreso += monto;
              }
            }
          }
          return { ingreso, gasto };
        } catch(e){
          return { ingreso: 0, gasto: 0 };
        }
      }

      // Observa cuando caja.js dibuja el historial y añade las 2 celdas nuevas por fila
      const tb = document.getElementById('tabla_historial');
      if (!tb) return;

      const procesarFilas = async () => {
        const filas = Array.from(tb.querySelectorAll('tr'));
        for (const tr of filas){
          const celdas = tr.querySelectorAll('td');
          if (!celdas.length) continue;

          // Si ya agregamos las 2 columnas, no repetir
          if (celdas.length >= 6) continue;

          const fecha = (celdas[0]?.textContent || '').trim();
          // Crear celdas provisionales
          const tdIngreso = document.createElement('td');
          tdIngreso.className = 'text-end';
          tdIngreso.textContent = '…';
          const tdGasto = document.createElement('td');
          tdGasto.className = 'text-end';
          tdGasto.textContent = '…';

          // Insertar antes de Observaciones (que es la última)
          if (celdas.length === 4){
            tr.insertBefore(tdIngreso, celdas[3]);
            tr.insertBefore(tdGasto, celdas[4]); // porque al insertar ingreso, el índice se corre
          } else {
            // fallback: al final
            tr.appendChild(tdIngreso);
            tr.appendChild(tdGasto);
          }

          // Calcular y actualizar
          if (fecha){
            const { ingreso, gasto } = await calcularTotalesPorFecha(fecha);
            tdIngreso.textContent = fmt(ingreso);
            tdGasto.textContent = fmt(gasto);
          } else {
            tdIngreso.textContent = fmt(0);
            tdGasto.textContent = fmt(0);
          }
        }
      };

      // Observer para actualizar cada vez que se redibuja el historial
      const obs = new MutationObserver(() => procesarFilas());
      obs.observe(tb, { childList: true });

      // Intento inicial por si ya hay datos
      document.addEventListener('DOMContentLoaded', procesarFilas);
      // Y un pequeño “retry” por si el fetch del historial demora
      setTimeout(procesarFilas, 800);
    })();
  </script>
</body>
</html>
